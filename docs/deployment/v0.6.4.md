<!--
Version: 0.6.4
-->
# v0.6.4 Deployment Guide

## Overview

This guide covers the deployment of v0.6.4 RAG Evaluation Gates for AI-Enhanced Dev Lab. This version includes comprehensive MCP server integration, terminal helper functions, and automated evaluation gates.

## Prerequisites

### System Requirements
- Python 3.11 or higher
- 4GB RAM minimum (8GB recommended)
- 2GB disk space for evaluation data
- Network access for MCP server communication

### Dependencies
- All packages from `requirements.txt`
- All packages from `requirements-dev.txt`
- Virtual environment activated

## Pre-Deployment Verification

### 1. Run Verification Script
```bash
python verify_v0_6_4.py
```

This script will:
- ✅ Check all required files exist
- ✅ Test MCP tools functionality
- ✅ Test MCP server endpoints
- ✅ Run RAG evaluation
- ✅ Verify all gates pass

### 2. Test MCP Server Locally
```bash
# Start MCP server
python -m uvicorn mcp_server.server:app --host 0.0.0.0 --port 8000

# In another terminal, test endpoints
curl http://localhost:8000/health
curl -X POST http://localhost:8000/tools/run_command \
  -H "Content-Type: application/json" \
  -d '{"command": "ls -la", "timeout": 10}'
```

## Deployment Steps

### 1. Environment Setup
```bash
# Create virtual environment
python -m venv .venv
source .venv/bin/activate  # On Windows: .venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt
pip install -r requirements-dev.txt
```

### 2. Configuration
```bash
# Verify MCP allowlist configuration
cat config/mcp/allowlist.yaml

# Should include all tools:
# - tools.run_command
# - tools.check_file
# - tools.read_file
# - tools.list_directory
# - tools.run_eval
# - tools.check_gates
```

### 3. Security Validation
```bash
# Validate security configuration
python scripts/ci/validate_mcp_allowlist.py

# Check security guardian
python -c "from lab.security.guardian import guardian; print('Security guardian loaded')"
```

### 4. MCP Server Deployment

#### Option A: Direct Python
```bash
# Start MCP server
python -m uvicorn mcp_server.server:app --host 0.0.0.0 --port 8000
```

#### Option B: Production with Gunicorn
```bash
# Install Gunicorn
pip install gunicorn

# Start with Gunicorn
gunicorn mcp_server.server:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

#### Option C: Docker (if Dockerfile exists)
```bash
# Build image
docker build -t ai-dev-lab:v0.6.4 .

# Run container
docker run -p 8000:8000 ai-dev-lab:v0.6.4
```

### 5. Verification
```bash
# Test health endpoint
curl http://localhost:8000/health

# Test all MCP endpoints
python verify_v0_6_4.py
```

## Production Configuration

### Environment Variables
```bash
# Set production environment
export ENVIRONMENT=production
export LOG_LEVEL=INFO
export MCP_PORT=8000
export MCP_HOST=0.0.0.0
```

### Logging Configuration
```bash
# Ensure logs directory exists
mkdir -p logs

# Set log permissions
chmod 755 logs/
```

### Security Hardening
```bash
# Review MCP allowlist
cat config/mcp/allowlist.yaml

# Validate security guardian
python -c "
from lab.security.guardian import guardian
print('Security guardian active')
print('Guarded tools:', list(guardian.guarded_tools.keys()))
"
```

## Monitoring and Maintenance

### Health Checks
```bash
# Basic health check
curl http://localhost:8000/health

# Detailed health check
curl http://localhost:8000/healthz
```

### Log Monitoring
```bash
# Monitor MCP server logs
tail -f logs/mcp_audit.jsonl

# Monitor evaluation logs
tail -f logs/eval.log
```

### Performance Monitoring
```bash
# Check server status
ps aux | grep uvicorn

# Monitor resource usage
top -p $(pgrep -f uvicorn)
```

## Troubleshooting

### Common Issues

#### 1. MCP Server Won't Start
```bash
# Check Python version
python --version  # Should be 3.11+

# Check dependencies
pip list | grep fastapi
pip list | grep uvicorn

# Check port availability
netstat -tulpn | grep 8000
```

#### 2. MCP Endpoints Not Working
```bash
# Test individual tools
python -c "
from mcp_server.tools.terminal_helper import run_command
result = run_command('ls -la', timeout=10)
print('Result:', result)
"

# Check security guardian
python -c "
from lab.security.guardian import guardian
print('Guardian status:', guardian.is_active)
"
```

#### 3. Evaluation Gates Failing
```bash
# Run evaluation manually
python eval/run.py --dataset eval/data/lab/lab_dev.jsonl --output eval/runs/debug

# Check metrics
cat eval/runs/debug/metrics.json

# Run gate check
python scripts/ci/parse_metrics.py eval/runs/debug/metrics.json
```

#### 4. Security Issues
```bash
# Validate allowlist
python scripts/ci/validate_mcp_allowlist.py

# Check guardian logs
grep "GUARDIAN" logs/mcp_audit.jsonl | tail -10
```

### Log Locations
- **MCP Server Logs**: `logs/mcp_audit.jsonl`
- **Evaluation Logs**: `logs/eval.log`
- **Application Logs**: `logs/app.log`
- **Error Logs**: `logs/error.log`

### Performance Tuning

#### Memory Optimization
```bash
# Monitor memory usage
free -h
ps aux --sort=-%mem | head -10

# Adjust worker count for Gunicorn
gunicorn mcp_server.server:app -w 2 -k uvicorn.workers.UvicornWorker
```

#### CPU Optimization
```bash
# Monitor CPU usage
top -p $(pgrep -f uvicorn)

# Adjust timeout settings in terminal_helper.py
```

## Rollback Procedure

### 1. Stop Current Service
```bash
# Find and stop MCP server
pkill -f uvicorn
pkill -f gunicorn
```

### 2. Restore Previous Version
```bash
# Git rollback
git checkout v0.6.3
pip install -r requirements.txt

# Or restore from backup
cp -r /backup/ai-dev-lab-v0.6.3/* .
```

### 3. Restart Service
```bash
# Start previous version
python -m uvicorn mcp_server.server:app --host 0.0.0.0 --port 8000
```

## Post-Deployment Checklist

- [ ] MCP server starts successfully
- [ ] All health endpoints respond
- [ ] All MCP tools work correctly
- [ ] Security guardian is active
- [ ] Evaluation pipeline runs
- [ ] All gates pass
- [ ] Logging is working
- [ ] Monitoring is in place
- [ ] Documentation is updated

## Support

### Getting Help
- Check logs first: `tail -f logs/mcp_audit.jsonl`
- Run verification: `python verify_v0_6_4.py`
- Review documentation: `docs/`

### Emergency Contacts
- Development Team: [Contact Info]
- System Administrator: [Contact Info]
- Security Team: [Contact Info]

## Version History

- **v0.6.4**: RAG Evaluation Gates with MCP integration
- **v0.6.3**: Previous stable version
- **v0.6.2**: Initial MCP server implementation

---

**Last Updated**: January 2025  
**Version**: v0.6.4  
**Status**: Production Ready
